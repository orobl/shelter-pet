{% extends "base.html" %}

{% block title %}Analytics | Happy Paws{% endblock %}

{% block content %}
<style>
.analytics-wrapper { padding: 2rem; }
.card { border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 2rem; background: rgba(255,255,255,0.95); }
.card h4 { color: #2e6072; margin-bottom: 1rem; }
.percentage-card { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-radius: 15px; background: #ff7b71; color: white; font-weight: 600; margin-bottom: 1rem; }
.percentage-card span { font-size: 1.5rem; }
.long-stay-table th, .long-stay-table td { vertical-align: middle; }
</style>

<div class="analytics-wrapper">
    <h2 class="text-center mb-4" style="color:#2e6072;">Shelter Analytics</h2>

    <div class="row">
        <!-- Line Chart -->
        <div class="col-md-8">
            <div class="card">
                <h4>Intakes vs Adoptions Over Time</h4>
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <!-- Status Pie Chart -->
        <div class="col-md-4">
            <div class="card">
                <h4>Animal Status</h4>
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="percentage-card">
                <span>Health Checks Completed</span>
                <span>{{ health_pct }}%</span>
            </div>
        </div>
        <div class="col-md-6">
            <div class="percentage-card" style="background:#2e6072;">
                <span>Spay/Neuter Completed</span>
                <span>{{ spay_pct }}%</span>
            </div>
        </div>
    </div>

    <!-- Long-stay alerts -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <h4>Long-Stay Animals (90+ days)</h4>
                {% if long_stays %}
                <table class="table long-stay-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Intake Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for animal in long_stays %}
                        <tr>
                            <td>{{ animal.name }}</td>
                            <td>{{ animal.intake_date }}</td>
                            <td>{{ animal.status }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                    <p>No long-stay animals at this time!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- Hidden JSON data for analytics -->
<script id="analytics-data" type="application/json">
{{ {
    "months": months,
    "intakes_counts": intakes_counts,
    "adoptions_counts": adoptions_counts,
    "status_labels": status_labels,
    "status_counts": status_counts
}|tojson }}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
    // Grab and parse the JSON
    const data = JSON.parse(document.getElementById('analytics-data').textContent);

    const months = data.months;
    const intakes = data.intakes_counts;
    const adoptions = data.adoptions_counts;
    const statusLabels = data.status_labels;
    const statusCounts = data.status_counts;

    // Line chart
    new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                { label: 'Intakes', data: intakes, borderColor: '#ff7b71', backgroundColor: 'rgba(255,123,113,0.2)', tension: 0.4 },
                { label: 'Adoptions', data: adoptions, borderColor: '#2e6072', backgroundColor: 'rgba(46,96,114,0.2)', tension: 0.4 }
            ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, stepSize: 1 } } }
    });

    // Pie chart
    new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: { labels: statusLabels, datasets: [{ data: statusCounts, backgroundColor: ['#2e6072','#ff7b71','#ffb347','#f9c74f','#90be6d'] }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
})();
</script>


{% endblock %}
